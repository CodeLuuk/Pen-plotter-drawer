<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simple Drawing to G-code</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #FF4D67;
      font-family: Arial, sans-serif;
    }

    h1 {
      text-align: center;
      margin-top: 20px;
      color: white;
    }

    .canvas-container {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px auto;
      width: fit-content;
    }

    canvas {
      border: 1px solid black;
      touch-action: none;
    }

    .tool-buttons {
      position: absolute;
      right: -70px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .tool-buttons img,
    .corner-button img {
      width: 50px;
      height: 50px;
      cursor: pointer;
      object-fit: contain;
    }

    .corner-button {
      position: absolute;
    }

    .clear-button {
      top: -60px;
      left: 0;
    }

    .launch-button {
      bottom: -60px;
      left: 0;
    }

    .bottom-buttons {
      text-align: center;
      margin-top: 20px;
    }

    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Draw and Convert to G-code</h1>

  <div class="canvas-container">
    <canvas id="drawCanvas" width="352" height="500"></canvas> <!-- A5 ratio -->

    <!-- Tools rechts -->
    <div class="tool-buttons">
      <img id="penBtn" src="images/pen_inactive.png" alt="Pen" onclick="selectTool('pencil')" />
      <img id="eraserBtn" src="images/eraser_inactive.png" alt="Eraser" onclick="selectTool('eraser')" />
    </div>

    <!-- Clear knop linksboven -->
    <div class="corner-button clear-button">
      <img src="images/clear.png" alt="Clear" onclick="clearCanvas()" />
    </div>

    <!-- Launch knop linksonder -->
    <div class="corner-button launch-button" id="launchBtn">
      <img id="launchBtnImg" src="images/launch_closed.png" alt="Launch" onclick="toggleLaunchButton()" />
    </div>
  </div>

  <!-- Download-knop onder canvas -->
  <div class="bottom-buttons">
    <button onclick="downloadGcode()">Download G-code</button>
  </div>

  <script>
    const canvas = document.getElementById('drawCanvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    let lastX = 0, lastY = 0;
    let strokes = [];
    let currentStroke = null;
    let currentTool = 'pencil';
    const eraseThreshold = 10;
    let launchOpen = false;

    const A5_WIDTH_MM = 148;
    const A5_HEIGHT_MM = 210;

    function redrawCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = 'black';
      for (const stroke of strokes) {
        for (const segment of stroke) {
          ctx.beginPath();
          ctx.moveTo(segment.x1, segment.y1);
          ctx.lineTo(segment.x2, segment.y2);
          ctx.stroke();
        }
      }
    }

    function startDraw(e) {
      const { offsetX, offsetY } = getTouchCoordinates(e);
      if (currentTool === 'eraser') {
        eraseAt(offsetX, offsetY);
        return;
      }
      drawing = true;
      currentStroke = [];
      [lastX, lastY] = [offsetX, offsetY];
    }

    function draw(e) {
      if (!drawing || currentTool === 'eraser') return;
      const { offsetX, offsetY } = getTouchCoordinates(e);
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(offsetX, offsetY);
      ctx.stroke();
      currentStroke.push({ x1: lastX, y1: lastY, x2: offsetX, y2: offsetY });
      [lastX, lastY] = [offsetX, offsetY];
    }

    function stopDraw() {
      if (drawing && currentStroke?.length > 0) {
        strokes.push(currentStroke);
        currentStroke = null;
      }
      drawing = false;
    }

    function eraseAt(x, y) {
      let modified = false;
      for (let i = strokes.length - 1; i >= 0; i--) {
        for (let seg of strokes[i]) {
          const dist = pointToSegmentDistance(x, y, seg);
          if (dist < eraseThreshold) {
            strokes.splice(i, 1);
            modified = true;
            break;
          }
        }
      }
      if (modified) redrawCanvas();
    }

    function pointToSegmentDistance(px, py, seg) {
      const { x1, y1, x2, y2 } = seg;
      const dx = x2 - x1;
      const dy = y2 - y1;
      const lengthSquared = dx * dx + dy * dy;
      if (lengthSquared === 0) return Math.hypot(px - x1, py - y1);
      let t = ((px - x1) * dx + (py - y1) * dy) / lengthSquared;
      t = Math.max(0, Math.min(1, t));
      const projX = x1 + t * dx;
      const projY = y1 + t * dy;
      return Math.hypot(px - projX, py - projY);
    }

    function selectTool(tool) {
      currentTool = tool;
      if (tool === 'pencil') {
        document.getElementById('penBtn').src = 'images/pen_active.png';
        document.getElementById('eraserBtn').src = 'images/eraser_inactive.png';
      } else if (tool === 'eraser') {
        document.getElementById('penBtn').src = 'images/pen_inactive.png';
        document.getElementById('eraserBtn').src = 'images/eraser_active.png';
      }
    }

    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      strokes = [];
    }

    function generateGcode() {
      const scaleX = A5_WIDTH_MM / canvas.width;
      const scaleY = A5_HEIGHT_MM / canvas.height;

      let gcode = "G21 ; Set units to mm\nG90 ; Absolute positioning\nG0 Z5 ; Lift pen\n";
      for (const stroke of strokes) {
        if (stroke.length === 0) continue;
        const first = stroke[0];
        gcode += `G0 X${(first.x1 * scaleX).toFixed(2)} Y${(first.y1 * scaleY).toFixed(2)}\n`;
        gcode += "G1 Z0 ; Lower pen\n";
        for (const segment of stroke) {
          gcode += `G1 X${(segment.x2 * scaleX).toFixed(2)} Y${(segment.y2 * scaleY).toFixed(2)} F1000\n`;
        }
        gcode += "G0 Z5 ; Lift pen\n";
      }
      return gcode;
    }

    function downloadGcode() {
      const gcode = generateGcode();
      const blob = new Blob([gcode], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'drawing.gcode';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function toggleLaunchButton() {
      const launchBtnImg = document.getElementById('launchBtnImg');
      if (launchOpen) {
        launchBtnImg.src = 'images/launch_closed.png';
      } else {
        launchBtnImg.src = 'images/launch_open.png';
      }
      launchOpen = !launchOpen;
    }

    function getTouchCoordinates(e) {
      let offsetX = 0, offsetY = 0;
      if (e.touches && e.touches.length > 0) {
        const rect = canvas.getBoundingClientRect();
        offsetX = e.touches[0].clientX - rect.left;
        offsetY = e.touches[0].clientY - rect.top;
      } else {
        offsetX = e.offsetX;
        offsetY = e.offsetY;
      }
      return { offsetX, offsetY };
    }

    // Events
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('mouseout', stopDraw);

    canvas.addEventListener('touchstart', e => {
      e.preventDefault();
      startDraw(e);
    }, { passive: false });

    canvas.addEventListener('touchmove', e => {
      e.preventDefault();
      draw(e);
    }, { passive: false });

    canvas.addEventListener('touchend', e => {
      e.preventDefault();
      stopDraw(e);
    }, { passive: false });
  </script>
</body>
</html>
